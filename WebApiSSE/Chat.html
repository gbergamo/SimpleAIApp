<!DOCTYPE html>
<html>
<head>
    <title>FakeGPT SSE Chat</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .message {
            margin-bottom: 10px;
        }

        .user-badge {
            background-color: #198754;
        }
        /* green */
        .ai-badge {
            background-color: #0d6efd;
        }
        /* blue */
        .spinner-container {
            display: inline-block;
            margin-left: 5px;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4">FakeGPT Using .NET 10 SSE Chat</h1>

        <div id="chat-box" class="mb-3"></div>

        <div class="input-group mb-3">
            <input type="text" id="input-box" class="form-control" placeholder="Type your message..." />
            <button class="btn btn-primary" id="send-btn">Send</button>
            <div id="spinner" class="spinner-border text-primary spinner-border-sm ms-2" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chat-box");
        const inputBox = document.getElementById("input-box");
        const sendBtn = document.getElementById("send-btn");
        const spinner = document.getElementById("spinner");

        function addMessage(role, text, badgeClass) {
            const msgDiv = document.createElement("div");
            msgDiv.className = "message";
            msgDiv.innerHTML = `<span class="badge ${badgeClass} me-2">${role}</span>${text}`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msgDiv;
        }

        function sendMessage() {
            const message = inputBox.value.trim();
            if (!message) return;

            addMessage("You", message, "user-badge");
            inputBox.value = "";
            sendBtn.disabled = true;
            spinner.style.display = "inline-block"; // show spinner

            if (window.evtSource) window.evtSource.close();

            const aiMsgDiv = addMessage("AI", "", "ai-badge");
            window.evtSource = new EventSource(`http://localhost:5041/chat?message=${encodeURIComponent(message)}`);
            let responseText = "";

            window.evtSource.onmessage = function (event) {
                responseText += event.data;
                aiMsgDiv.innerHTML = `<span class="badge ai-badge me-2">AI</span>${responseText}`;
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            window.evtSource.onerror = function () {
                window.evtSource.close();
                sendBtn.disabled = false;
                spinner.style.display = "none"; // hide spinner
            };
        }

        sendBtn.addEventListener("click", sendMessage);
        inputBox.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });
    </script>
</body>
</html>
